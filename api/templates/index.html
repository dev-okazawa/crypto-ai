{% extends "base.html" %}

{% block page_css %}
<link rel="stylesheet" href="/static/css/index.css">
{% endblock %}

{% block content %}

<div class="container index-wrapper">

  <div class="sort-bar">

    <a href="/?sort=marketcap_desc"
       class="sort-btn {% if current_sort == 'marketcap_desc' %}active{% endif %}">
       MarketCap ↑
    </a>

    <a href="/?sort=marketcap_asc"
       class="sort-btn {% if current_sort == 'marketcap_asc' %}active{% endif %}">
       MarketCap ↓
    </a>

    <a href="/?sort=change_desc"
       class="sort-btn {% if current_sort == 'change_desc' %}active{% endif %}">
       Change ↑
    </a>

    <a href="/?sort=change_asc"
       class="sort-btn {% if current_sort == 'change_asc' %}active{% endif %}">
       Change ↓
    </a>

  </div>

  <div class="coin-list">

    {% for coin in coins %}
    <a href="/prediction?symbol={{ coin.symbol }}" class="coin-link">

      <div class="coin-card">

        <!-- Header -->
        <div class="coin-top">
          <div class="coin-info">
            <img src="{{ coin.image or '/static/img/default.png' }}"
                 alt="{{ coin.symbol }}"
                 class="coin-icon">
            <div class="coin-name">
              {{ coin.name }}
              <span class="muted">/USDT</span>
            </div>
          </div>
        </div>

        <!-- Body -->
        <div class="coin-body">

          <div class="coin-prices">

            <!-- Current -->
            <div class="price-row">
              <span class="label">Current</span>
              <span class="price"
                    data-price="{{ coin.current_price }}"></span>
            </div>

            <!-- Predicted -->
            <div class="price-row">
              <span class="label">Predicted</span>
              <span class="price"
                    data-price="{{ coin.predicted_price }}"></span>
            </div>

            <!-- Change -->
            <div class="price-row">
              <span class="label">Change</span>

              <span class="change"
                    data-diff="{{ coin.change }}"
                    data-pct="{{ coin.change_percent }}">
              </span>

            </div>

          </div>

          <!-- Mini Chart -->
          <div class="mini-chart">
            <canvas id="chart-{{ coin.symbol }}"></canvas>
          </div>

        </div>

      </div>

    </a>
    {% endfor %}

  </div>

</div>

{% endblock %}

{% block page_scripts %}

<script id="coin-data" type="application/json">
{{ coins | tojson | safe }}
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {

  if (typeof formatUSD !== "function" ||
      typeof formatDiff !== "function") return;

  /* ===== Price ===== */
  document.querySelectorAll(".price").forEach(el => {
    const value = el.dataset.price;
    if (!value) return;
    el.innerHTML = formatUSD(value);
  });

  /* ===== Change ===== */
  document.querySelectorAll(".change").forEach(el => {

    const diff = Number(el.dataset.diff);
    const pct  = Number(el.dataset.pct);

    const direction =
      diff > 0 ? "up" :
      diff < 0 ? "down" :
      "flat";

    el.innerHTML =
      `<span class="${direction}">
        ${formatDiff(diff, pct)}
      </span>`;
  });

});
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="/static/js/indexChart.js"></script>

{% endblock %}