{% extends "base.html" %}

{% block page_css %}
<link rel="stylesheet" href="/static/css/index.css">
{% endblock %}

{% block content %}
<div class="container index-wrapper">

  <div class="index-topbar">
    <div class="top-right">
      {% if last_updated %}
        <span class="updated-label">Last Updated (UTC)</span>
        <span class="updated-time">{{ last_updated[:16].replace("T", " ") }}</span>
      {% endif %}
    </div>
  </div>

  <section class="accuracy-ranking-wrapper">
    <h2 class="section-title"><span>ğŸ”¥</span> Top AI Accuracy</h2>
    <div class="ranking-grid-container">
      {% if accuracy_ranking %}
        {% for item in accuracy_ranking %}
        <a href="/prediction?symbol={{ item.symbol }}{% if 'USDT' not in item.symbol %}USDT{% endif %}" class="accuracy-card-mini">
          <div class="card-header-row">
            <div class="rank-badge-mini">RANK {{ loop.index }}</div>
            {% if loop.index <= 3 %}
              <div class="ai-pick-badge-visualize">ğŸ”¥ AI HIT</div>
            {% endif %}
          </div>
          
          <div class="rank-info-mini">
            <div class="symbol-container">
              {% set ns = namespace(icon="") %}
              {% for c in coins %}
                {% if c.symbol == item.symbol or c.symbol == item.symbol ~ 'USDT' %}
                  {% set ns.icon = c.image %}
                {% endif %}
              {% endfor %}
              
              {% set symbol_name = item.symbol.replace('USDT', '').strip().lower() %}
              {# ä¾‹å¤–ãªã—ï¼š1.APIå–å¾—URL 2.Binanceå…¬å¼é™çš„URL 3.å¤–éƒ¨ã‚«ãƒ©ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³è£œå®Œ #}
              <img src="{{ ns.icon if ns.icon else 'https://static.binance.com/static/images/home/market/icon/' ~ symbol_name ~ '.png' }}" 
                   class="rank-icon" 
                   alt="{{ item.symbol }}" 
                   onerror="this.onerror=null; this.src='https://raw.githubusercontent.com/spothq/cryptocurrency-icons/master/128/color/{{ symbol_name }}.png';">
              
              <div class="symbol-text-box">
                <strong class="rank-symbol">{{ item.symbol.replace('USDT', '') }}</strong>
              </div>
            </div>

            <div class="rank-value-group">
              <span class="rank-accuracy">{{ item.accuracy }}</span><span class="rank-label">%</span>
            </div>
          </div>
          <div class="rank-stats-mini">{{ item.count }} Predictions</div>
        </a>
        {% endfor %}
      {% endif %}
    </div>
  </section>

  <section class="middile-area">
    <div class="top-left">
      <a href="/prediction" class="nav-button">ğŸ”® Prediction</a>
    </div>  
  </section>

  <section class="market-section-header">
    <h2 class="section-title"><span>âœ¨</span> AI Prediction</h2>
  </section>

  <div class="sort-bar" id="sort-bar">
    <button data-sort="marketcap_desc" class="sort-btn active">MarketCap â†‘</button>
    <button data-sort="marketcap_asc" class="sort-btn">MarketCap â†“</button>
    <button data-sort="change_desc" class="sort-btn">Change â†‘</button>
    <button data-sort="change_asc" class="sort-btn">Change â†“</button>
  </div>

  <div class="coin-list" id="coin-list-container">
    {% for coin in coins %}
    <a href="/prediction?symbol={{ coin.symbol }}" class="coin-link" data-symbol="{{ coin.symbol }}">
      <div class="coin-card">
        <div class="coin-top">
          <div class="coin-info">
            {% set c_symbol = coin.symbol.replace('USDT', '').strip().lower() %}
            <img src="{{ coin.image if coin.image else 'https://static.binance.com/static/images/home/market/icon/' ~ c_symbol ~ '.png' }}" 
                 alt="" 
                 class="coin-icon" 
                 onerror="this.onerror=null; this.src='https://raw.githubusercontent.com/spothq/cryptocurrency-icons/master/128/color/{{ c_symbol }}.png';">
            <span class="coin-name">{{ coin.name }}/USDT</span>
          </div>
        </div>
        <div class="coin-body">
          <div class="coin-prices">
            <div class="price-row"><span class="label">Current</span><span class="price" data-price="{{ coin.current_price }}"></span></div>
            <div class="price-row"><span class="label">Predicted</span><span class="price" data-price="{{ coin.predicted_price }}"></span></div>
            <div class="price-row"><span class="label">Change</span><span class="change" data-diff="{{ coin.change }}" data-pct="{{ coin.change_percent }}"></span></div>
          </div>
          <div class="mini-chart"><canvas id="chart-{{ coin.symbol }}"></canvas></div>
        </div>
      </div>
    </a>
    {% endfor %}
  </div>

</div>
{% endblock %}

{% block page_scripts %}
<script id="coin-data" type="application/json">
{{ coins | tojson | safe }}
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="/static/js/index.js"></script>
{% endblock %}